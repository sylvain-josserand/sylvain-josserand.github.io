<!DOCTYPE html>
<html>
<head>
    <title>Support de formation sur Django avancé</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=1024, user-scalable=no">

    <!-- Required stylesheet -->
    <link rel="stylesheet" media="screen" href="core/deck.core.css">

    <!-- Extension CSS files go here. Remove or add as needed. -->
    <link rel="stylesheet" media="screen" href="extensions/goto/deck.goto.css">
    <link rel="stylesheet" media="screen" href="extensions/menu/deck.menu.css">
    <link rel="stylesheet" media="screen" href="extensions/navigation/deck.navigation.css">
    <link rel="stylesheet" media="screen" href="extensions/status/deck.status.css">
    <link rel="stylesheet" media="screen" href="extensions/scale/deck.scale.css">

    <!-- Style theme. More available in /themes/style/ or create your own. -->
    <link rel="stylesheet" media="screen" href="themes/style/swiss.css">

    <!-- Transition theme. More available in /themes/transition/ or create your own. -->
    <link rel="stylesheet" media="screen" href="themes/transition/fade.css">
    <!-- Basic black and white print styles -->
    <link rel="stylesheet" media="print" href="core/print.css">

    <!-- Required Modernizr file -->
    <script src="modernizr.custom.js"></script>
</head>
<body>
<div class="deck-container">

    <!-- Begin slides. Just make elements with a class of slide. -->
    <div class="slide">
        <h2>Bienvenue!</h2>
        <ul>
            <li>Les présentations</li>
            <br>
            <li>Logistique de la formation</li>
            <br>
            <li>Attentes</li>
            <br>
            <li>Installation de Python 3.5, PyCharm et Django 1.11</li>
        </ul>
    </div>
    <div class="slide">
        <h2>Ressources</h2>
        <ul>
            <li>Documentation de Django: <a href="https://docs.djangoproject.com/fr/1.11/">https://docs.djangoproject.com/fr/1.11/</a></li>
            <br>
            <li>Django Snippets: <a href="https://djangosnippets.org/">https://djangosnippets.org/</a></li>
            <br>
            <li>Django Rest Framework: <a href="http://www.django-rest-framework.org/">http://www.django-rest-framework.org/</a></li>
        </ul>
        <blockquote>
            <p>Read the Source, Luke</p>
            <p><cite>Yoda</cite></p>
        </blockquote>
    </div>
    <div class="slide">
        <h2>Les modèles</h2>
        <blockquote>Lorsque vous concevez des applications complexes, centralisez (autant que possible)
            la logique "métier" dans les <b>modèles</b> et leurs <b>méthodes<b>
        </blockquote>
    </div>
    <div class="slide">
        <h2>Révisions rapides</h2>
        <ul>
            <li>Models</li>
            <br>
            <li>Fields</li>
            <br>
            <li>Managers</li>
        </ul>
    </div>
    <div class="slide">
        <h2>Héritage de modèles</h2>
        <ul>
            <li>abstract</li>
            <br>
            <li>Héritage multiple</li>
            <br>
            <li>proxy (modèles mandataires)</li>
            <br>
            <li>Imports circulaires</li>
        </ul>
    </div>
    <div class="slide">
        <h2>abstract</h2>
        <p>👍 Ajouter des champs générique pour tous vos modèles</p>
        <p>👎 Colonnes supplémentaires (pas optimal si données souvent vides)</p>
        <p>👎 Pas d'héritage multiple avec abstract</p>
        <pre>
class DatedModel(Model):
    class Meta:
        abstract = True
    created = DateTimeField(auto_now_add=True)
    modified = DateTimeField(auto_now=True)

class Company(DatedModel):
    name = TextField()
date = DatedModel()  # Objection!
fedex = Company(name="Fedex")
fedex.created
        </pre>
    </div>
    <div class="slide">
        <h2>Héritage multiple (1/2)</h2>
        <p>Création d'un OneToOneField automatique vers le parent et l'enfant si il existe</p>
        <pre>
class Vehicle(DatedModel):
    color = CharField()

class Truck(Vehicle):
    owner = ForeignKey(Company)
        </pre>
    </div>
    <div class="slide">
        <h2>Héritage multiple (2/2)</h2>
        <p>Tous les champs de Vehicle seront aussi disponible dans Truck, même si les données se trouveront dans des <b>tables différentes</b></p>
        <p>👍 Possibilité d'hériter de plusieurs classes, modèles de base (Vehicle) non-modifié et accessible</p>
        <p>👍 Pratique pour étendre en conservant l'existant</p>
        <p>👎 Jointures ou requêtes supplémentaires</p>
        <p>👎 Peut complexifier le code (vérification d'existance de sous-objets)</p>
        <pre>
mon_camion = Truck(color='red', owner=fedex)
mon_camion.color
mon_camion.vehicle
mon_camion.save()  # Pour obtenir l'ID
mon_vehicule = Vehicle.objects.get(pk=mon_camion.id)
assert mon_vehicule.truck == mon_camion
        </pre>
    </div>
    <div class="slide">
        <h2>proxy (modèles mandataires)</h2>
        <a href="https://docs.djangoproject.com/fr/1.11/topics/db/models/#proxy-models">Doc Django</a>
        <p>Permet de modifier le comportement d'un modèle sans changer la façon dont il stocke ses données</p>
        <pre>
class Car(Vehicle):
    class Meta:
        proxy = True
    def __str__(self):
        return "{} car".format(self.color)
    def paint(self, color):
        self.color = color
        </pre>
    </div>
    <div class="slide">
        <h2>Imports circulaires</h2>
        <p>Si vous rencontrez le message d'erreur "Cannot import &lt;module&gt;", il peut s'agir d'un problème d'import circulaire</p>
        <p>La solution consiste à importer le module dans la méthode où il est utilisée, plutôt qu'à la racine, en haut du fichier</p>
        <p>Pour les clefs étrangères, plutôt que la classe elle-même, utilisez une chaîne contenant son nom</p>
        <pre>
class Truck(Vehicle):
    owner = ForeignKey(Company)
        </pre>
        <p>Devient:</p>
        <pre>
class Truck(Vehicle):
    owner = ForeignKey("Company")
        </pre>
    </div>
    <div class="slide">
        <h2>Création d'un champ personnalisé (1/2)</h2>
        <p>👍 Les champs personnalisés permettent de stocker des données arbitraires tout en contrôlant la façon dont on les enregistre</p>
        <p>👍 Peut engendrer des gains de performance spectaculaires dans ceraines circonstances</p>
        <p>👎 Attention aux implémentations qui dépendent du moteur de base de données</p>
        <p>👎 Dé-corrélation avec les données physiquement présentes dans la base</p>
        <p>👎 Peut engendrer une certaine complexité: un niveau d'abstraction en plus (en trop?)</p>
    </div>
    <div class="slide">
        <h2>Création d'un champ personnalisé (2/2)</h2>
        <p>
        <pre>
class CharMaxlength25Field(models.Field):
    def db_type(self, connection):
        return 'char(25)'  # Type spécifique à Postgresql

class BetterCharField(models.Field):
    def __init__(self, max_length, *args, **kwargs):
        self.max_length = max_length
        super(BetterCharField, self).__init__(*args, **kwargs)

    def db_type(self, connection):
        return 'char(%s)' % self.max_length  # Version paramétrique
        </pre>
        </p>
    </div>
    <div class="slide">
        <h2>Création d'un Manager personnalisé (1/2)</h2>
        <p>Chaque modèle possède un manager par défaut, il s'agit de l'attribut <i>objects</i></p>
        <p>Un manager personnalisé permet de limiter (ou d'enrichir) le queryset lié à un modèle</p>
        <p>Au lieu de requêter sur l'ensemble des objets comme on le fait sur <i>objects</i>, on se limite à un sous-ensemble</p>
        <p>👍 Améliore la qualité du code, c'est à dire sa facilité de compréhension et sa maintenabilité</p>
        <p>👎 Il faut se rappeler de l'utiliser 😅</p>
    </div>
    <div class="slide">
        <h2>Création d'un Manager personnalisé (2/2)</h2>
        <p>Par exemple, un manager personnalisé peut être utilisé pour cacher des objets au lieu de les supprimer</p>
        <p>Cela permet d'ajouter une corbeille dans votre application, ou une fonction d'annulation de suppression</p>
        <pre>
            class ActiveUserManager(models.Manager):
                def get_queryset(self):
                    return super(UserManager, self).get_queryset().filter(active=True)

            class User(models.Model):
                active = BooleanField(default=True)
                active_objects = ActiveManager()
        </pre>
    </div>
    <div class="slide">
        <h2>Mise en pratique</h2>
        <p>
            <ol>
                <li>Créez un nouveau projet: application de gestion de finances personnelles</li>
                <li>Créer un modèle Expense</li>
                <li>Ce modèle doit stocker les données de façon efficiente et utiliser les éléments suivants:</li>
                <ul>
                    <li>Hériter d'un modèle abstrait: DatedModel</li>
                    <li>Posséder un champ personnalisé: MoneyField qui stocke les somme d'argent sous forme d'entiers dans la base (avec les centimes)</li>
                    <li>Utiliser un Manager personnalisé: active_objects</li>
                </ul>
            </ol>
        </p>
    </div>
    <div class="slide">
        <h2>Tests unitaires</h2>
        <blockquote>
            Les tests unitaires permettent de limiter les bugs induits et donc vous donnent confiance dans la robustesse de votre application
        </blockquote>
    </div>
    <div class="slide">
        <h2>Écrire des tests sous Django</h2>
        <p>
            Plusieurs classes existent pour réaliser des tests unitaires sous Django:
            <ul>
                <li>django.test.TestCase</li>
                <ul>
                    <li>django.test.TransactionTestCase</li>
                    <ul>
                        <li>django.test.LiveServerTestCase: Lance un vrai serveur Django ce qui permet de tester l'interface avec Selenium ou PhantomJS</li>
                        <li>django.test.StaticLiveServerTestCase: Idem + fichiers statiques sans avoir besoin de lancer collectstatic</li>
                    </ul>
                </ul>
            </ul>
        </p>
    </div>
    <div class="slide">
        <h2>Patching et Mocking</h2>
        <p>
            <ul>
                <li>unittest.mock</li>
                <li>unittest.patch</li>
            </ul>
        </p>
    </div>
    <div class="slide">
        <h2>Couverture de code (code coverage)</h2>
        <p>
            L'outil <i>coverage</i><br>
            <a href="https://coverage.readthedocs.io/en/coverage-4.4.2/">https://coverage.readthedocs.io/en/coverage-4.4.2/</a>
            <pre>
                # pip install coverage
                coverage run manage.py test
            </pre>
        </p>
        <p>PyCharm Professional intègre un outil de couverture de code</p>
    </div>
    <div class="slide">
        <h2>Mise en pratique</h2>
        <p>
            Écrire les tests unitaires de notre application exemple
        </p>
        <h3>Bonus</h3>
        <p>
            Interfacer notre application avec <a href="http://fixer.io">fixer.io</a> et mocker la requête.
        </p>
    </div>
    <div class="slide">
        <h2>Requêtes avancées</h2>
        <blockquote>
            <p>L'ORM de Django permet de réconcilier le modèle Objet de Python avec le stockage SQL...</p>
            <p>Au prix d'une multiplication des requêtes, qui peut ralentir considérablement notre application</p>
            <p>Nous allons voir comment mitiger ce problème</p>
        </blockquote>
    </div>
    <div class="slide">
        <h2>Annotate: avantages et limites</h2>
        <p>Annotate permet l'équivalent d'un <i>group by</i> en SQL</p>
        <p>Compter le nombre de dépenses par utilisateur:</p>
        <pre>
from django.db.models import Count
user = User.objects.all().annotate(Count('expense_set'))[0]
user.expense_set__count
        </pre>
        <p>Compter le total par utilisateur:</p>
        <pre>
from django.db.models import Sum
user = User.objects.all().annotate(total=Sum('expense_set__amount'))
user.total
        </pre>
        <p>Une seule requête à chaque fois!</p>
    </div>
    <div class="slide">
        <h2>Aggregate</h2>
        <p>Aggregate permet d'aggréger des données en une seule par somme ou comptage</p>
        <pre>
from django.db.models import Sum
User.objects.all().aggregate(grand_total=Sum('expense_set__amount'))
        </pre>
    </div>
    <div class="slide">
        <h2>Utilisation avancée de select_related et prefetch_related</h2>
        <h3>select_related</h3>
        <p>
            <i>select_related</i> permet d'économiser une requête lorsqu'on accède à un objet lié à un autre par une clef étrangère
            <pre>
expense = Expense.objects.get(pk=1)  # 1 requête
expense.user  # 1 requête

expense = Expense.objects.select_related('user').get(pk=1)  # 1 requête
expense.user  # Pas de requête!
            </pre>
        </p>
    </div>
    <div class="slide">
        <h2>Utilisation avancée de select_related et prefetch_related</h2>
        <h3>select_related</h3>
        <p>
            <i>select_related</i> permet d'économiser une requête lorsqu'on accède à un objet lié à un autre par une clef étrangère
        <pre>
for expense in Expense.objects.all()  # 1 requête
    expense.user  # 1 requête à chaque fois!

for expense in Expense.objects.select_related('user').get(pk=1)  # 1 requête avec jointure
    expense.user  # Pas de requête!
            </pre>
        </p>
    </div>
    <div class="slide">
        <h2>Utilisation avancée de select_related et prefetch_related</h2>
        <h3>prefetch_related</h3>
        <p>
            <i>prefetch_related</i> permet d'éviter de multiplier les requêtes quand on accède à un OneToMany (ForeignKey inversée)
            <pre>
        for user in User.objects.all():  # 1 requête
            for expense in user.expense_set.all():  # 1 requête par user!
                print(expense.amount)

        for user in User.objects.prefetch_related('expense_set').all():  # 2 requêtes: 1 pour User + 1 pour Expense
            for expense in user.expense_set.all():  # Pas de requête!
                print(expense.amount)
            </pre>
        </p>
    </div>
    <div class="slide"><h2>Mise en pratique</h2>
        <p>Réduction du nombre de requêtes</p>
    </div>
    <!-- Jour 2 -->
    <div class="slide"><h2>Les vues</h2></div>
    <div class="slide"><h2>Révision des bases: Les vues sous forme de clases (class-based views)</h2></div>
    <div class="slide"><h2>Vues génériques: TemplateView, ListView, ...</h2></div>
    <div class="slide"><h2>Les Mixin</h2></div>
    <div class="slide"><h2>Les middleware</h2></div>
    <div class="slide"><h2>Mise en pratique: Création d'un mixin de vue générique et d'un middleware</h2></div>
    <div class="slide"><h2>Les templates</h2></div>
    <div class="slide"><h2>Révision des bases: Filters et Tags</h2></div>
    <div class="slide"><h2>Filters personnalisés</h2></div>
    <div class="slide"><h2>Tags personnalisés</h2></div>
    <div class="slide"><h2>Mise en pratique: Création d'un filtre personalisé</h2></div>
    <div class="slide"><h2>Sécurité avancée</h2></div>
    <div class="slide"><h2>Révision des bases: protection contre le XSS (csrf token)</h2></div>
    <div class="slide"><h2>Customisation de l'authentification: JWT et clef d'API</h2></div>
    <div class="slide"><h2>Authentification par OAuth</h2></div>
    <div class="slide"><h2>Mise en pratique: Gérer la séparation des données dans notre application</h2></div>
    <!-- Jour 3 -->
    <div class="slide"><h2>Migrations de données</h2></div>
    <div class="slide"><h2>Migration de données: Python et SQL</h2></div>
    <div class="slide"><h2>Fusion de migrations</h2></div>
    <div class="slide"><h2>Mise en pratique: Créer une migration de données personnalisée</h2></div>
    <div class="slide"><h2>Django Rest Framework</h2></div>
    <div class="slide"><h2>Les ViewSets</h2></div>
    <div class="slide"><h2>Les Serializers</h2></div>
    <div class="slide"><h2>Mise en pratique: Ajouter une API auto-documentée à notre application</h2></div>
    <div class="slide"><h2>Performance</h2></div>
    <div class="slide"><h2>Django Debug Toolbar</h2></div>
    <div class="slide"><h2>Gestion du cache</h2></div>
    <div class="slide"><h2>Mise en pratique: améliorer les performances de notre application</h2></div>
    <div class="slide"><h2>Gardons contact</h2><p><a href="mailto:sylvain@intuitivo.fr">sylvain@intuitivo.fr</a></p><p><a href="http://intuitivo.fr">intuitivo.fr</a></p></div>

    <!-- End slides. -->

    <!-- Begin extension snippets. Add or remove as needed. -->

    <!-- deck.navigation snippet -->
    <div aria-role="navigation">
        <a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
        <a href="#" class="deck-next-link" title="Next">&#8594;</a>
    </div>

    <!-- deck.status snippet -->
    <p class="deck-status" aria-role="status">
        <span class="deck-status-current"></span>
        /
        <span class="deck-status-total"></span>
    </p>

    <!-- deck.goto snippet -->
    <form action="." method="get" class="goto-form">
        <label for="goto-slide">Go to slide:</label>
        <input type="text" name="slidenum" id="goto-slide" list="goto-datalist">
        <datalist id="goto-datalist"></datalist>
        <input type="submit" value="Go">
    </form>

    <!-- End extension snippets. -->
</div>

<!-- Required JS files. -->
<script src="jquery.min.js"></script>
<script src="core/deck.core.js"></script>

<!-- Extension JS files. Add or remove as needed. -->
<script src="extensions/menu/deck.menu.js"></script>
<script src="extensions/goto/deck.goto.js"></script>
<script src="extensions/status/deck.status.js"></script>
<script src="extensions/navigation/deck.navigation.js"></script>
<script src="extensions/scale/deck.scale.js"></script>

<!-- Initialize the deck. You can put this in an external file if desired. -->
<script>
    $(function () {
        $.deck('.slide');
    });
</script>
</body>
</html>
